<analysis>**original_problem_statement:**
The user wants to build a Board-First deterministic, adaptive chess coaching system. This is a major redesign of the existing Coach/Focus page.

**PRODUCT REQUIREMENTS:**

**ðŸš€ FEATURE: Board-First Coach Page (No-Book UX)**

**Goal:** Transform the Focus/Coach page into an interactive session with minimal text and maximum board interaction.

*   **Layout:**
    *   **Left:** A sticky, always-visible chessboard with controls for highlighting, arrows, stepping through moves (Next/Prev), and a Try Move mode for interactive drills.
    *   **Right:** A coach panel with a maximum of three tabs: , , and .

*   **1. AUDIT TAB â€“ Show Me Where I Broke The Plan**
    *   Replace the text-based domain audit with 3-5 Key Moments from the last game.
    *   Each Key Moment is a card with a label (e.g., Hanging piece), move number, eval swing, a View on Board button, and a Try Again button for a mini-drill.
    *   **Interactivity:** Clicking View jumps the board to the position and highlights the relevant pieces. Clicking Try Again puts the user in a drill where they must play a correct move to fix the mistake.

*   **2. PLAN TAB â€“ Next Game Plan = 1 Opening Line + 2 Habits + 3 Drills**
    *   The plan must be playable, not just readable.
    *   **A) Opening Line Drill:** Show one specific opening line (5-8 moves) based on user stats. The board plays it, then the user must repeat it.
    *   **B) Coach Habits:** A maximum of two high-level habits (e.g., No hanging pieces), each linked to a drill.
    *   **C) Drill Positions:** Three interactive drills sourced from the user's own recent games, targeting their specific weakness cluster. Each drill is a single position where the user must find the correct move.

*   **3. OPENINGS TAB â€“ Your Repertoire Trainer**
    *   A minimal tab showing the user's primary opening for each color, openings to avoid, and a 1 line to know today board demo.

*   **ðŸ§  Deterministic Intelligence (Backend Logic):**
    *   **Key Moment Selection:** The backend must deterministically select 3-5 key moments from a game based on criteria like the biggest eval drops, first plan violation, hung pieces, advantage collapses, and time trouble blunders.
    *   **Plan Drill Selection:** Drills should be selected based on the user's repeated failure types and adjusted for their rating band (e.g., 600-1000 focus on hanging pieces; 1600-2000 focus on calculation discipline).
    *   **Drill Validation:** Use Stockfish to validate user moves in drills, accepting the top 2-3 best moves.

**User's preferred language**: English

**what currently exists?**
The application has a text-based Deterministic Adaptive Coach on the  page. The backend for this is complete, featuring a  that generates plans and audits based on:
- Granular rating bands (e.g., 1000-1400).
- A 5-level Training Intensity system that escalates based on consecutive misses in a domain (e.g., Tactics, Middlegame).
- Analysis of the last 25 games to identify primary and secondary weaknesses.

The current UI on the  page renders this text-based plan, showing intensity levels, escalated domains, and focus items from the last game. This backend logic now serves as the foundation for the new Board-First UI.

**Last working item**:
-   **Last item agent was working:** The agent acknowledged and planned the user's major new feature request: The Board-First Coach Page. The agent proposed a phased approach, starting with building the board infrastructure and the 3-tab layout.
-   **Status:** NOT STARTED
-   **Agent Testing Done:** N
-   **Which testing method agent to use?** both
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1: Tactics Audit Data Inconsistency (P1)**
    -   **Description:** During the development of the text-based coach, the agent noticed the plan audit sometimes reported No blunders in the tactics domain, even when the underlying analysis data contained blunders.
    -   **Status:** TESTING PENDING. The agent attempted a fix, but it was not rigorously verified before the user pivoted to the new feature. This needs to be re-checked to ensure data integrity for the new Key Moments feature.

**In progress Task List**:
-   **Task 1: Implement Board-First Coach Page (P0)**
    -   **Description:** This is a complete overhaul of the  page UI and parts of the backend API to align with the user's new Show me, dont tell me" philosophy.
    -   **Where to resume:** Start with Phase 1:
        1.  Integrate the `chessground` library into the `Focus.jsx` component to create the sticky chessboard on the left.
        2.  Implement the basic 3-tab layout on the right (`Audit`, `Plan`, `Openings`).
        3.  Develop the API for the board (e.g., `jumpToMove(moveNo)`, `highlightSquare()`).
    -   **What will be achieved with this?** A new, highly interactive coaching experience that replaces long text paragraphs with board-centric drills and visualizations.
    -   **Status:** NOT STARTED
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on something:** None.

**Upcoming and Future Tasks**
-   **P1: Historical Game Analysis:** Create a one-time script to find all games in the database that are missing analysis data and queue them for the `analysis_worker`.
-   **P2: Optimize Analysis Speed:** Consider changing the Stockfish analysis depth from 18 to a lower value (e.g., 12 or 14) in `backend/config.py` to speed up analysis.

**Completed work in this session**
-   **Backend for Deterministic Coach (Foundation for new UI):**
    -   Created `backend/services/deterministic_coaching_service.py` with logic for granular rating bands, a 5-level adaptive intensity system, and plan/audit generation based on weakness patterns from the last 25 games.
    -   Updated `backend/server.py` to use this new service for coaching endpoints.
    -   Fixed a critical `ObjectId` JSON serialization bug in the API responses.
-   **Frontend for Text-Based Coach:**
    -   Updated `frontend/src/pages/Focus.jsx` and the `DomainPlanCard.jsx` component to render the richer data from the new service, including intensity levels (e.g., "L3", "3/5") and "Escalated" badges.
-   **Testing:**
    -   Successfully used the `testing_agent_v3_fork` to validate the entire text-based deterministic coach feature, with all backend and frontend tests passing.
-   **Routing:**
    -   Resolved the `/coach` vs. `/focus` route inconsistency. Both URLs now correctly render the `Focus.jsx` component.

**Earlier issues found/mentioned but not fixed**
-   None other than the "Tactics Audit Data Inconsistency" listed in pending issues.

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork:** Stockfish executable disappears on container resets.
-   **Recurrence count:** 1
-   **Status:** RESOLVED. An `ensure_stockfish_installed` function in `backend/analysis_worker.py` handles this.

**Code Architecture**
```
/app
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ deterministic_coaching_service.py # NEW: Core logic for new coach.
â”‚   â”‚   â”œâ”€â”€ coaching_loop_service.py          # Legacy, to be phased out or refactored.
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ server.py                             # MODIFIED: Endpoints use the new deterministic service.
â”‚   â””â”€â”€ ...
â””â”€â”€ frontend/
    â””â”€â”€ src/
        â”œâ”€â”€ pages/
        â”‚   â”œâ”€â”€ Focus.jsx                     # MODIFIED: Renders new data. Needs full refactor for board-first UI.
        â”‚   â””â”€â”€ ...
        â””â”€â”€ components/
            â”œâ”€â”€ DomainPlanCard.jsx            # MODIFIED: Displays intensity levels. Will be replaced.
            â””â”€â”€ ...
```

**Key Technical Concepts**
-   **Board-First UX:** The new core principle. User interaction should be centered on the chessboard, not reading text.
-   **Key Moments:** The backend must identify the 3-5 most important teaching moments from a game to be displayed in the Audit tab.
-   **Interactive Drills:** Users are given positions from their own games and must play a move, which is then validated by the system.
-   **Sticky Chessboard:** A persistent UI element that is central to the new design, requiring a library like `chessground`.
-   **Deterministic Coaching Logic:** The already-built backend system (rating bands, intensity levels, weakness analysis) will be used to select which drills and key moments to show.

**key DB schema**
-   **users:** The `plan_history` array now stores richer plan objects generated by the `deterministic_coaching_service`, including `intensity` levels and `priority` (primary/secondary). No new tables/collections were added.

**All files of reference**
-   `backend/services/deterministic_coaching_service.py`: Contains the core logic that will power the new UI. Will need to be adapted to generate "Key Moments" and "Drills".
-   `frontend/src/pages/Focus.jsx`: The main page to be completely refactored for the "Board-First" design.
-   `backend/server.py`: API endpoints will need to be changed to serve FENs, move numbers, and drill data instead of text blocks.

**Areas that need refactoring**:
-   The entire `frontend/src/pages/Focus.jsx` component and its children must be rebuilt to accommodate the new "Board-First" layout.
-   The `deterministic_coaching_service.py` needs to be refactored to output "Key Moments" and "Drill Positions" instead of the current text-based plan structure.

**key api endpoints**
-   `GET /api/coaching/round-preparation`: Currently returns a text-based plan. **Needs refactor** to return data for the "Plan" tab (Opening line, 2 habits, 3 drills).
-   `GET /api/coaching/plan-audit`: Currently returns a text-based audit. **Needs refactor** to return data for the "Audit" tab (3-5 Key Moments).

**Critical Info for New Agent**
-   **Major Pivot:** The user has completely changed the direction of the Focus/Coach page. The previous work on a text-based coach is now just a backend foundation. The new, non-negotiable priority is the interactive, "Board-First" UX.
-   **"Show, Dont Tell:** This is the user's guiding philosophy. Every critical insight must be backed by a clickable position on the board. Minimize text.
-   **Phased Approach:** The accepted plan is to start with Phase 1: integrating the  chessboard library and building the basic 3-tab shell (, , ) in .

**documents and test reports created in this job**
-    (Updated with the old deterministic coach details)
-    (Test report for the text-based coach)

**Last 10 User Messages and any pending HUMAN messages**
1.  **User:** yes , and common lines that user should learn first but whenever could be derived , do that too, very smart brother you know - Confirmed drill validation rules and encouraged smart derivation of opening lines.
2.  **Agent:** Proposed a phased plan to build the Board-First feature, starting with board infrastructure.
3.  **User:** use chessground , drill validation accept top 2-3 moves - Provided specific technical direction for implementation.
4.  **Agent:** Acknowledged the user's new feature request and asked for confirmation on the plan.
5.  **User:** Defined the entire Board-First Coach Page feature in great detail, including layout, the three tabs (Audit, Plan, Openings), interactivity, and the deterministic logic for selecting drills. This is the new primary requirement.
6.  **User:** Clarified the difference between Plan Audit (report card) and Focus from Last Game (tactical lesson).
7.  **Agent:** Answered the user's question about the difference between the 'Round Preparation' and 'Plan Audit' sections.
8.  **Agent:** Successfully completed and verified the text-based deterministic coach implementation with the testing agent.
9.  **Agent:** Identified an inconsistency in the UI data (primary vs. secondary weakness) and correctly deduced the logic was sound based on the underlying data.
10. **User:** go with 5 levels, use last 25 games, Yes P0 now - Confirmed the parameters for the deterministic coach logic and set it as the highest priority.

**Project Health Check:**
-   **Broken:** None
-   **Mocked:** 

**3rd Party Integrations**
-   **Stockfish:** Chess engine for analysis and drill validation.
-   **chessground:** (To be added) The required frontend library for the interactive chessboard.

**Testing status**
-   **Testing agent used after significant changes:** YES (For the previous text-based feature)
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** None
-   **Known regressions:** None

**Credentials to test flow:**
None required. Use the Dev Login button on the landing page.

**What agent forgot to execute**
The agent correctly pivoted to the user's new, major request. All previous plans are now superseded by the Board-First Coach Page implementation. Nothing was forgotten.</analysis>
